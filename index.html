<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Banana Radar ¬∑ v1 Alpha</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0e13; --panel:#121722; --panel2:#0f1420;
      --line:#1f2937; --muted:#6b7280; --text:#e5e7eb;
      --gold:#fbbf24; --good:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:24px}

    header{margin-bottom:18px}
    h1{margin:0;font-size:1.8rem;font-weight:700}
    .subtitle{font-size:.78rem;color:var(--muted);margin-top:4px}

    .status-bar{
      background:var(--panel2);border:1px solid var(--line);
      border-radius:12px;padding:12px 16px;font-size:.72rem;
      display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;
      color:var(--muted);margin-bottom:18px;
    }
    .status-pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--line);
      color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good);display:inline-block}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .col{
      background:transparent;
    }

    .col-head{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      margin-bottom:10px;
    }
    .col-title{
      font-size:.78rem;
      letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .col-meta{
      font-size:.62rem;color:var(--muted);
      border:1px solid var(--line);
      background:#0b1220;
      padding:5px 8px;border-radius:999px;
    }

    .card{
      background:var(--panel);border:1px solid var(--line);
      border-radius:16px;padding:14px;margin-bottom:12px;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .symbol{font-size:1.02rem;font-weight:700;color:var(--gold)}
    .score{font-size:1.28rem;font-weight:700}

    .timeline-row{
      font-size:.68rem;color:var(--muted);margin-top:6px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .badges{margin-top:9px;display:flex;gap:7px;flex-wrap:wrap}
    .badge{
      display:inline-block;font-size:.60rem;padding:4px 8px;border-radius:999px;
      background:#1b2433;border:1px solid var(--line);color:#cbd5f5;
    }
    .narrative{margin-top:9px;font-size:.70rem;color:#d1d5db;line-height:1.35}

    .card-actions{margin-top:11px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .btn-link{
      cursor:pointer;border:1px solid var(--line);background:#0b1220;color:var(--text);
      padding:7px 10px;border-radius:10px;font-size:.64rem;text-decoration:none;
    }
    .liq{font-size:.60rem;color:var(--muted)}

    footer{margin-top:28px;font-size:.62rem;color:var(--muted);text-align:center;line-height:1.4}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;
      z-index:999;
    }
    .modal{
      width:min(820px,100%);
      background:var(--panel);border:1px solid var(--line);
      border-radius:18px;overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.4);
    }
    .modal-head{
      background:var(--panel2);border-bottom:1px solid var(--line);
      padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px
    }
    .modal-title{font-weight:700}
    .modal-sub{font-size:.68rem;color:var(--muted);margin-top:2px}
    .modal-close{
      cursor:pointer;border:1px solid var(--line);background:#0b1220;color:var(--text);
      padding:6px 10px;border-radius:10px;font-size:.65rem;
    }
    .modal-body{padding:14px 16px}
    .tl-item{
      border:1px solid var(--line);border-radius:14px;padding:12px 12px;margin-bottom:10px;
      background:#101827;
    }
    .tl-top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .tl-evt{font-size:.72rem;font-weight:700}
    .tl-time{font-size:.62rem;color:var(--muted)}
    .tl-detail{margin-top:6px;font-size:.68rem;color:#d1d5db;line-height:1.35}
    .loading{font-size:.7rem;color:var(--muted)}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>üçå Banana Radar</h1>
      <div class="subtitle">Consensus Radar for New Tokens</div>
    </header>

    <div class="status-bar">
      <div class="status-pill"><span class="dot"></span> SYSTEM: ACTIVE</div>
      <div class="status-pill" id="last-update">Last Evaluation: --</div>
      <div class="status-pill" id="observed-count">Tokens Observed: --</div>
    </div>

    <!-- 3-zone feed -->
    <div class="grid">
      <div class="col">
        <div class="col-head">
          <div class="col-title">CORE</div>
          <div class="col-meta" id="core-meta">‚Äî</div>
        </div>
        <div id="core-list"></div>
      </div>

      <div class="col">
        <div class="col-head">
          <div class="col-title">STABLE</div>
          <div class="col-meta" id="stable-meta">‚Äî</div>
        </div>
        <div id="stable-list"></div>
      </div>

      <div class="col">
        <div class="col-head">
          <div class="col-title">EARLY</div>
          <div class="col-meta" id="early-meta">‚Äî</div>
        </div>
        <div id="early-list"></div>
      </div>
    </div>

    <footer>
      Signals are formed, tested, and invalidated over time.<br/>
      This system does not predict outcomes.
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="modal-title">Timeline</div>
          <div class="modal-sub" id="modal-sub">‚Äî</div>
        </div>
        <button class="modal-close" id="modal-close">Close</button>
      </div>
      <div class="modal-body">
        <div id="modal-content" class="loading">Loading‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
  // ====== Fill these two ======
  const SB_URL = "https://ctizvqaqnsavuawprgzu.supabase.co";
   const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aXp2cWFxbnNhdnVhd3ByZ3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzQwMzYsImV4cCI6MjA4MjE1MDAzNn0.-op8Pbjwv8YAPAFg7mnIk1tHgA1vi4Vf7i4yufvLaAA";
  // ===========================
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Per-zone max items
  const LIMIT_CORE = 5;
  const LIMIT_STABLE = 5;
  const LIMIT_EARLY = 6;

  function fmtTime(ts){
    try{ return new Date(ts).toLocaleString(); }catch(e){ return ts; }
  }

  function observedMinutes(item){
    const base = item.first_passed_at || item.created_at;
    if (!base) return 0;
    const mins = Math.max(0, Math.floor((Date.now() - new Date(base).getTime()) / 60000));
    return mins;
  }

  function zoneOf(item){
    if (item.core_confirmed) return "CORE";
    if (item.stable_confirmed) return "STABLE";
    // EARLY ÂåÖÂê´Ôºöforming_confirmed + ËøòÊ≤° forming ÁöÑÔºàÁúüÊ≠£Êó©ÊúüÔºâ
    return "EARLY";
  }

  function zoneLabel(item){
    if (item.core_confirmed) return "CORE CONSENSUS";
    if (item.stable_confirmed) return "STABLE CONSENSUS";
    if (item.forming_confirmed) return "FORMING CONSENSUS";
    return "EARLY CONSENSUS";
  }

  function renderCard(item){
    const mins = observedMinutes(item);
    const label = zoneLabel(item);

    const badges = `
      <span class="badge">Liquidity Verified</span>
      ${item.smart_money_count > 0 ? `<span class="badge">Smart Money Detected</span>` : ``}
      <span class="badge">Narrative Logged</span>
    `;

    return `
      <div class="card">
        <div class="card-header">
          <div class="symbol">$${item.symbol ?? "???"}</div>
          <div class="score">${(item.banana_score ?? 0).toFixed(2)}</div>
        </div>

        <div class="timeline-row">
          <div>${label}</div>
          <div>Observed <b>${mins}m</b></div>
        </div>

        <div class="badges">${badges}</div>

        <div class="narrative">"${item.narrative_log ?? "‚Äî"}"</div>

        <div class="card-actions">
          <button class="btn-link" onclick="openTimeline('${item.ca}','${item.symbol ?? ""}')">View Timeline</button>
          <div class="liq">LIQ: $${Math.round(item.liq ?? 0).toLocaleString()}</div>
        </div>
      </div>
    `;
  }

  function setMetaCounts(coreN, stableN, earlyN){
    document.getElementById("core-meta").innerText = `${coreN} shown`;
    document.getElementById("stable-meta").innerText = `${stableN} shown`;
    document.getElementById("early-meta").innerText = `${earlyN} shown`;
  }

  async function loadThreeZoneFeed(){
    // ‰∏ÄÊ¨°ÊÄßÂèñÊõ¥Â§öÊï∞ÊçÆÔºåÁÑ∂ÂêéÂâçÁ´ØÂàÜÂå∫ÔºàÈÅøÂÖç‰∏âÊ¨°ËØ∑Ê±ÇÔºâ
    // ËøôÈáåÂèñ 30 Êù° passedÔºåÂü∫Êú¨Â§üÂàÜÂå∫‰∫Ü
    const { data } = await sb
      .from("pending_pool")
      .select("ca,symbol,liq,banana_score,smart_money_count,narrative_log,created_at,first_passed_at,forming_confirmed,stable_confirmed,core_confirmed")
      .eq("status","passed")
      .order("banana_score",{ascending:false})
      .limit(30);

    const coreList = [];
    const stableList = [];
    const earlyList = [];

    (data || []).forEach(item => {
      const z = zoneOf(item);
      if (z === "CORE" && coreList.length < LIMIT_CORE) coreList.push(item);
      else if (z === "STABLE" && stableList.length < LIMIT_STABLE) stableList.push(item);
      else if (z === "EARLY" && earlyList.length < LIMIT_EARLY) earlyList.push(item);
    });

    document.getElementById("core-list").innerHTML = coreList.map(renderCard).join("") || `<div class="loading">No CORE tokens yet.</div>`;
    document.getElementById("stable-list").innerHTML = stableList.map(renderCard).join("") || `<div class="loading">No STABLE tokens yet.</div>`;
    document.getElementById("early-list").innerHTML = earlyList.map(renderCard).join("") || `<div class="loading">No EARLY tokens yet.</div>`;

    setMetaCounts(coreList.length, stableList.length, earlyList.length);

    document.getElementById("last-update").innerText = "Last Evaluation: just now";
    document.getElementById("observed-count").innerText = "Tokens Observed: " + (data?.length || 0);
  }

  // ===== Timeline Modal =====
  const backdrop = document.getElementById("modal-backdrop");
  document.getElementById("modal-close").onclick = () => closeTimeline();
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeTimeline(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeTimeline(); });

  function eventTitle(evt){
    const map = {
      "FIRST_AUDIT_DONE": "Initial audit completed",
      "FIRST_PASSED": "Passed initial threshold",
      "SMART_MONEY_DETECTED": "Smart money detected",
      "SCORE_UPDATE": "Score updated",
      "CONSENSUS_FORMING": "Consensus forming",
      "CONSENSUS_STABLE": "Consensus stabilized",
      "CONSENSUS_CORE": "Core consensus established"
    };
    return map[evt] || evt;
  }

  function eventDetail(evt, payload){
    payload = payload || {};
    if (evt === "FIRST_AUDIT_DONE"){
      return `Score ${payload.score ?? "‚Äî"} ¬∑ Liquidity $${Math.round(payload.liq_usd ?? 0).toLocaleString()} ¬∑ Smart ${payload.smart_money_count ?? 0}`;
    }
    if (evt === "FIRST_PASSED"){
      return `Score ${payload.score ?? "‚Äî"}`;
    }
    if (evt === "SMART_MONEY_DETECTED"){
      return `Smart wallets: ${payload.smart_money_count ?? "‚Äî"}`;
    }
    if (evt === "SCORE_UPDATE"){
      const prev = payload.previous_score ?? "‚Äî";
      const now = payload.score ?? "‚Äî";
      const delta = payload.delta ?? "‚Äî";
      return `Score ${prev} ‚Üí ${now} (${delta >= 0 ? "+" : ""}${delta})`;
    }
    if (evt === "CONSENSUS_FORMING" || evt === "CONSENSUS_STABLE" || evt === "CONSENSUS_CORE"){
      return `Sustained for ${payload.minutes_sustained ?? "‚Äî"} minutes ¬∑ Tier: ${payload.tier ?? "‚Äî"}`;
    }
    return JSON.stringify(payload);
  }

  async function openTimeline(ca, symbol){
    document.getElementById("modal-title").innerText = `Timeline ¬∑ $${symbol || "???"}`;
    document.getElementById("modal-sub").innerText = ca;
    document.getElementById("modal-content").innerHTML = `<div class="loading">Loading‚Ä¶</div>`;
    backdrop.style.display = "flex";

    const { data, error } = await sb
      .from("token_timeline")
      .select("event,payload,created_at")
      .eq("ca", ca)
      .order("created_at", { ascending: false })
      .limit(40);

    if (error){
      document.getElementById("modal-content").innerHTML =
        `<div class="loading">Failed to load timeline: ${error.message}</div>`;
      return;
    }

    if (!data || data.length === 0){
      document.getElementById("modal-content").innerHTML =
        `<div class="loading">No timeline yet. (Brain will write events after next audits.)</div>`;
      return;
    }

    const html = data.map(row => `
      <div class="tl-item">
        <div class="tl-top">
          <div class="tl-evt">${eventTitle(row.event)}</div>
          <div class="tl-time">${fmtTime(row.created_at)}</div>
        </div>
        <div class="tl-detail">${eventDetail(row.event, row.payload)}</div>
      </div>
    `).join("");

    document.getElementById("modal-content").innerHTML = html;
  }

  function closeTimeline(){
    backdrop.style.display = "none";
  }

  // initial + refresh
  loadThreeZoneFeed();
  setInterval(loadThreeZoneFeed, 10000);
</script>

</body>
</html>
