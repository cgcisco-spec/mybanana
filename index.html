<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Banana Radar ¬∑ v1 Alpha</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0e13; --panel:#121722; --panel2:#0f1420;
      --line:#1f2937; --muted:#6b7280; --text:#e5e7eb;
      --gold:#fbbf24; --good:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:24px}

    header{margin-bottom:18px}
    h1{margin:0;font-size:1.8rem;font-weight:700}
    .subtitle{font-size:.78rem;color:var(--muted);margin-top:4px}

    .status-bar{
      background:var(--panel2);border:1px solid var(--line);
      border-radius:12px;padding:12px 16px;font-size:.72rem;
      display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;
      color:var(--muted);margin-bottom:18px;
    }
    .status-pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--line);
      color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good);display:inline-block}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .col{
      background:transparent;
    }

    .col-head{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      margin-bottom:10px;
    }
    .col-title{
      font-size:.78rem;
      letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .col-meta{
      font-size:.62rem;color:var(--muted);
      border:1px solid var(--line);
      background:#0b1220;
      padding:5px 8px;border-radius:999px;
    }

    .card{
      background:var(--panel);border:1px solid var(--line);
      border-radius:16px;padding:14px;margin-bottom:12px;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .symbol{font-size:1.02rem;font-weight:700;color:var(--gold)}
    .score{font-size:1.28rem;font-weight:700}

    .timeline-row{
      font-size:.68rem;color:var(--muted);margin-top:6px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .badges{margin-top:9px;display:flex;gap:7px;flex-wrap:wrap}
    .badge{
      display:inline-block;font-size:.60rem;padding:4px 8px;border-radius:999px;
      background:#1b2433;border:1px solid var(--line);color:#cbd5f5;
    }
    .narrative{margin-top:9px;font-size:.70rem;color:#d1d5db;line-height:1.35}

    .card-actions{margin-top:11px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .btn-link{
      cursor:pointer;border:1px solid var(--line);background:#0b1220;color:var(--text);
      padding:7px 10px;border-radius:10px;font-size:.64rem;text-decoration:none;
    }
    .liq{font-size:.60rem;color:var(--muted)}

    footer{margin-top:28px;font-size:.62rem;color:var(--muted);text-align:center;line-height:1.4}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;
      z-index:999;
    }
    .modal{
      width:min(820px,100%);
      background:var(--panel);border:1px solid var(--line);
      border-radius:18px;overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.4);
    }
    .modal-head{
      background:var(--panel2);border-bottom:1px solid var(--line);
      padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px
    }
    .modal-title{font-weight:700}
    .modal-sub{font-size:.68rem;color:var(--muted);margin-top:2px}
    .modal-close{
      cursor:pointer;border:1px solid var(--line);background:#0b1220;color:var(--text);
      padding:6px 10px;border-radius:10px;font-size:.65rem;
    }
    .modal-body{padding:14px 16px}
    .tl-item{
      border:1px solid var(--line);border-radius:14px;padding:12px 12px;margin-bottom:10px;
      background:#101827;
    }
    .tl-top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .tl-evt{font-size:.72rem;font-weight:700}
    .tl-time{font-size:.62rem;color:var(--muted)}
    .tl-detail{margin-top:6px;font-size:.68rem;color:#d1d5db;line-height:1.35}
    .loading{font-size:.7rem;color:var(--muted)}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>üçå Banana Radar</h1>
      <div class="subtitle">Consensus Radar for New Tokens</div>
    </header>

    <div class="status-bar">
      <div class="status-pill"><span class="dot"></span> SYSTEM: ACTIVE</div>
      <div class="status-pill" id="last-update">Last Evaluation: --</div>
      <div class="status-pill" id="observed-count">Tokens Observed: --</div>
    </div>

    <!-- 3-zone feed -->
    <div class="grid">
      <div class="col">
        <div class="col-head">
          <div class="col-title">CORE</div>
          <div class="col-meta" id="core-meta">‚Äî</div>
        </div>
        <div id="core-list"></div>
      </div>

      <div class="col">
        <div class="col-head">
          <div class="col-title">STABLE</div>
          <div class="col-meta" id="stable-meta">‚Äî</div>
        </div>
        <div id="stable-list"></div>
      </div>

      <div class="col">
        <div class="col-head">
          <div class="col-title">EARLY</div>
          <div class="col-meta" id="early-meta">‚Äî</div>
        </div>
        <div id="early-list"></div>
      </div>
    </div>

    <footer>
      Signals are formed, tested, and invalidated over time.<br/>
      This system does not predict outcomes.
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="modal-title">Timeline</div>
          <div class="modal-sub" id="modal-sub">‚Äî</div>
        </div>
        <button class="modal-close" id="modal-close">Close</button>
      </div>
      <div class="modal-body">
        <div id="modal-content" class="loading">Loading‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
  // ====== Fill these two ======
  let sb = null;

async function initSupabaseFromConfig() {
  const r = await fetch("/api/config", { cache: "no-store" });
  const cfg = await r.json();

  if (!cfg.ok) {
    throw new Error(cfg.error || "Failed to load /api/config");
  }

  sb = supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
}

  // ===========================
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Per-zone max items
  const LIMIT_CORE = 5;
  const LIMIT_STABLE = 5;
  const LIMIT_EARLY = 6;

  function fmtTime(ts){
    try{ return new Date(ts).toLocaleString(); }catch(e){ return ts; }
  }

  function observedMinutes(item){
    const base = item.first_passed_at || item.created_at;
    if (!base) return 0;
    const mins = Math.max(0, Math.floor((Date.now() - new Date(base).getTime()) / 60000));
    return mins;
  }

  function zoneOf(item){
    if (item.core_confirmed) return "CORE";
    if (item.stable_confirmed) return "STABLE";
    // EARLY ÂåÖÂê´Ôºöforming_confirmed + ËøòÊ≤° forming ÁöÑÔºàÁúüÊ≠£Êó©ÊúüÔºâ
    return "EARLY";
  }

  function zoneLabel(item){
    if (item.core_confirmed) return "CORE CONSENSUS";
    if (item.stable_confirmed) return "STABLE CONSENSUS";
    if (item.forming_confirmed) return "FORMING CONSENSUS";
    return "EARLY CONSENSUS";
  }

  function renderCard(item){
    const mins = observedMinutes(item);
    const label = zoneLabel(item);

    const badges = `
      <span class="badge">Liquidity Verified</span>
      ${item.smart_money_count > 0 ? `<span class="badge">Smart Money Detected</span>` : ``}
      <span class="badge">Narrative Logged</span>
    `;

    return `
      <div class="card">
        <div class="card-header">
          <div class="symbol">$${item.symbol ?? "???"}</div>
          <div class="score">${(item.banana_score ?? 0).toFixed(2)}</div>
        </div>

        <div class="timeline-row">
          <div>${label}</div>
          <div>Observed <b>${mins}m</b></div>
        </div>

        <div class="badges">${badges}</div>

        <div class="narrative">"${item.narrative_log ?? "‚Äî"}"</div>

        <div class="card-actions">
          <button class="btn-link" onclick="openTimeline('${item.ca}','${item.symbol ?? ""}')">View Timeline</button>
          <div class="liq">LIQ: $${Math.round(item.liq ?? 0).toLocaleString()}</div>
        </div>
      </div>
    `;
  }

  function setMetaCounts(coreN, stableN, earlyN){
    document.getElementById("core-meta").innerText = `${coreN} shown`;
    document.getElementById("stable-meta").innerText = `${stableN} shown`;
    document.getElementById("early-meta").innerText = `${earlyN} shown`;
  }

  async function loadThreeZoneFeed(){
  // ‰∏ÄÊ¨°ËØ∑Ê±ÇÊãøÂà∞‰∏âÂàÜÂå∫Êï∞ÊçÆ
  const r = await fetch("/api/feed?limit=50", { cache: "no-store" });
  const js = await r.json();

  if (!js.ok) {
    throw new Error(js.error || "Failed to load /api/feed");
  }

  // ËøôÈáåÂèØ‰ª•Âú®ÂâçÁ´ØÂÜçË£ÅÂâ™ÊØè‰∏™ zone ÊòæÁ§∫Êï∞Èáè
  const coreList = (js.zones.core || []).slice(0, LIMIT_CORE);
  const stableList = (js.zones.stable || []).slice(0, LIMIT_STABLE);
  const earlyList = (js.zones.early || []).slice(0, LIMIT_EARLY);

  document.getElementById("core-list").innerHTML =
    coreList.length ? coreList.map((x, i) => renderCard(x, i+1)).join("")
                    : renderEmpty("No sustained consensus yet. Monitoring CORE candidates‚Ä¶");

  document.getElementById("stable-list").innerHTML =
    stableList.length ? stableList.map((x, i) => renderCard(x, i+1)).join("")
                      : renderEmpty("No stable consensus yet. Signals need time to stabilize‚Ä¶");

  document.getElementById("early-list").innerHTML =
    earlyList.length ? earlyList.map((x, i) => renderCard(x, i+1)).join("")
                     : renderEmpty("No early signals right now. Hunter is scanning‚Ä¶");

  // Radar Summary Bar + Zone meta
  setZoneMeta(coreList.length, stableList.length, earlyList.length);

  // È°∂ÈÉ® observed ÊÄªÊï∞ÔºàÁî® total Êõ¥ÁúüÂÆûÔºâ
  document.getElementById("observed-count").innerText = js.counts?.total ?? (coreList.length + stableList.length + earlyList.length);

  // last update ÊòæÁ§∫Ôºöjust now / ÊàñËÄÖÁî® js.ts Êõ¥‚ÄúÁ≥ªÁªü‚Äù
  document.getElementById("last-update").innerText = "just now";
}


  // ===== Timeline Modal =====
  const backdrop = document.getElementById("modal-backdrop");
  document.getElementById("modal-close").onclick = () => closeTimeline();
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeTimeline(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeTimeline(); });

  function eventTitle(evt){
    const map = {
      "FIRST_AUDIT_DONE": "Initial audit completed",
      "FIRST_PASSED": "Passed initial threshold",
      "SMART_MONEY_DETECTED": "Smart money detected",
      "SCORE_UPDATE": "Score updated",
      "CONSENSUS_FORMING": "Consensus forming",
      "CONSENSUS_STABLE": "Consensus stabilized",
      "CONSENSUS_CORE": "Core consensus established"
    };
    return map[evt] || evt;
  }

  function eventDetail(evt, payload){
    payload = payload || {};
    if (evt === "FIRST_AUDIT_DONE"){
      return `Score ${payload.score ?? "‚Äî"} ¬∑ Liquidity $${Math.round(payload.liq_usd ?? 0).toLocaleString()} ¬∑ Smart ${payload.smart_money_count ?? 0}`;
    }
    if (evt === "FIRST_PASSED"){
      return `Score ${payload.score ?? "‚Äî"}`;
    }
    if (evt === "SMART_MONEY_DETECTED"){
      return `Smart wallets: ${payload.smart_money_count ?? "‚Äî"}`;
    }
    if (evt === "SCORE_UPDATE"){
      const prev = payload.previous_score ?? "‚Äî";
      const now = payload.score ?? "‚Äî";
      const delta = payload.delta ?? "‚Äî";
      return `Score ${prev} ‚Üí ${now} (${delta >= 0 ? "+" : ""}${delta})`;
    }
    if (evt === "CONSENSUS_FORMING" || evt === "CONSENSUS_STABLE" || evt === "CONSENSUS_CORE"){
      return `Sustained for ${payload.minutes_sustained ?? "‚Äî"} minutes ¬∑ Tier: ${payload.tier ?? "‚Äî"}`;
    }
    return JSON.stringify(payload);
  }

  async function openTimeline(ca, symbol){
  document.getElementById("modal-title").innerText = `Timeline ¬∑ $${symbol || "???"}`;
  document.getElementById("modal-sub").innerText = ca;
  document.getElementById("modal-content").innerHTML = `<div class="loading">Loading‚Ä¶</div>`;
  backdrop.style.display = "flex";

  try{
    const r = await fetch(`/api/timeline?ca=${encodeURIComponent(ca)}&limit=50`, { cache: "no-store" });
    const js = await r.json();

    if (!js.ok){
      document.getElementById("modal-content").innerHTML =
        `<div class="loading">Failed to load timeline: ${js.error || "unknown error"}</div>`;
      return;
    }

    const data = js.timeline || [];
    if (!data.length){
      document.getElementById("modal-content").innerHTML =
        `<div class="loading">No timeline yet. (Brain will write events after next audits.)</div>`;
      return;
    }

    const html = data.map(row => `
      <div class="tl-item">
        <div class="tl-top">
          <div class="tl-evt">${eventTitle(row.event)}</div>
          <div class="tl-time">${fmtTime(row.created_at)}</div>
        </div>
        <div class="tl-detail">${eventDetail(row.event, row.payload)}</div>
      </div>
    `).join("");

    document.getElementById("modal-content").innerHTML = html;

  } catch (e){
    console.error(e);
    document.getElementById("modal-content").innerHTML =
      `<div class="loading">Failed to load timeline (network error).</div>`;
  }
}


  function closeTimeline(){
    backdrop.style.display = "none";
  }

  // initial + refresh
 (async () => {
  try {
    // ÂÖàÂàùÂßãÂåñÈÖçÁΩÆ
    await initSupabaseFromConfig();

    // ÂÜçÂêØÂä®È°µÈù¢ÈÄªËæë
    await loadThreeZoneFeed();

    // ÂÄíËÆ°Êó∂ + ÂÆöÊó∂Âà∑Êñ∞
    setInterval(tick, 1000);
    setInterval(async () => {
      secondsLeft = Math.floor(REFRESH_MS / 1000);
      await loadThreeZoneFeed();
    }, REFRESH_MS);

  } catch (e) {
    console.error(e);

    // ÁªôÁî®Êà∑‰∏Ä‰∏™ÂèØËßÅÊèêÁ§∫ÔºàÈÅøÂÖçÁôΩÂ±èÔºâ
    const core = document.getElementById("core-list");
    const stable = document.getElementById("stable-list");
    const early = document.getElementById("early-list");
    const msg = `<div class="empty">Config load failed. Check /api/config and Vercel env vars.</div>`;
    if (core) core.innerHTML = msg;
    if (stable) stable.innerHTML = msg;
    if (early) early.innerHTML = msg;

    const last = document.getElementById("last-update");
    if (last) last.innerText = "config error";
  }
})();

</script>

</body>
</html>
