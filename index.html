<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Banana Radar ¬∑ v1 Alpha</title>

<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0e13;
  --panel:#121722;
  --panel2:#0f1420;
  --line:#1f2937;
  --muted:#6b7280;
  --text:#e5e7eb;
  --gold:#fbbf24;

  --early:#64748b;
  --forming:#38bdf8;
  --stable:#a78bfa;
  --core:#fbbf24;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:24px}

/* ---------- Header ---------- */
header{margin-bottom:12px}
h1{margin:0;font-size:1.8rem;font-weight:900}
.subtitle{font-size:.78rem;color:var(--muted);margin-top:6px}

/* ---------- Radar Summary ---------- */
.radar-bar{
  margin:14px 0 18px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:linear-gradient(180deg,#0f1420,#0b0f19);
  display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
  font-size:.72rem;color:var(--muted);
}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  background:#0b1220;border:1px solid var(--line);
}
.value{color:var(--text);font-weight:900}

/* ---------- Zones ---------- */
.zones{display:flex;flex-direction:column;gap:14px}
.zone{border-radius:18px;border:1px solid var(--line);overflow:hidden}
.zone-head{
  padding:14px 16px;
  background:linear-gradient(180deg,#0f1420,#0b0f19);
  border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;
}
.zone-title{font-weight:900;letter-spacing:1px}
.zone-sub{font-size:.7rem;color:var(--muted)}
.zone-body{padding:12px}

/* ---------- Card ---------- */
.card{
  background:linear-gradient(180deg,#121722,#0f1420);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}
.card-top{
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px;
}
.symbol{
  font-size:1.05rem;font-weight:900;color:var(--gold);
}
.score{
  font-size:1.2rem;font-weight:900;
}

/* ---------- Consensus Badge ---------- */
.badge{
  font-size:.62rem;
  font-weight:900;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  display:inline-flex;align-items:center;
}
.badge.EARLY{color:var(--early)}
.badge.FORMING{color:var(--forming)}
.badge.STABLE{color:var(--stable)}
.badge.CORE{color:var(--core)}

/* ---------- Progress Bar ---------- */
.progress-wrap{
  margin-top:10px;
}
.progress-label{
  font-size:.6rem;color:var(--muted);
  display:flex;justify-content:space-between;
}
.progress{
  height:6px;border-radius:999px;
  background:#0b1220;border:1px solid var(--line);
  overflow:hidden;margin-top:4px;
}
.progress-bar{
  height:100%;
  background:linear-gradient(90deg,#38bdf8,#a78bfa,#fbbf24);
  width:0%;
}

/* ---------- Narrative ---------- */
.narrative{
  margin-top:10px;
  font-size:.7rem;color:#d1d5db;
  line-height:1.35;
}

/* ---------- Actions ---------- */
.actions{
  margin-top:10px;
  display:flex;justify-content:space-between;align-items:center;
}
.btn{
  border:1px solid var(--line);
  background:#0b1220;
  color:var(--text);
  padding:7px 10px;
  border-radius:10px;
  font-size:.62rem;
  cursor:pointer;
}
.liq{font-size:.6rem;color:var(--muted)}

.empty{font-size:.7rem;color:var(--muted);padding:12px;text-align:center}

/* ---------- Modal (Timeline) ---------- */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;padding:18px;
  z-index:999;
}
.modal{
  width:min(820px,100%);
  max-height:85vh;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:18px;
  overflow:hidden;
  display:flex;flex-direction:column;
}
.modal-head{
  padding:14px 16px;
  background:var(--panel2);
  border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;
}
.modal-body{padding:14px 16px;overflow-y:auto}
.modal-close{
  border:1px solid var(--line);
  background:#0b1220;
  color:var(--text);
  border-radius:10px;
  font-size:.65rem;
  padding:6px 10px;
  cursor:pointer;
}
.tl-item{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;margin-bottom:8px;
  background:#101827;
}
.tl-top{display:flex;justify-content:space-between}
.tl-evt{font-size:.7rem;font-weight:900}
.tl-time{font-size:.6rem;color:var(--muted)}
.tl-detail{margin-top:6px;font-size:.68rem;color:#d1d5db}

</style>
</head>

<body>
<div class="container">

<header>
  <h1>üçå Banana Radar</h1>
  <div class="subtitle">Consensus Radar for New Tokens</div>
</header>

<div class="zones">
  <div class="zone">
    <div class="zone-head"><div>CORE ZONE</div><div class="zone-sub">Sustained consensus</div></div>
    <div class="zone-body" id="core-list"></div>
  </div>
  <div class="zone">
    <div class="zone-head"><div>STABLE ZONE</div><div class="zone-sub">Emerging stability</div></div>
    <div class="zone-body" id="stable-list"></div>
  </div>
  <div class="zone">
    <div class="zone-head"><div>EARLY ZONE</div><div class="zone-sub">Under observation</div></div>
    <div class="zone-body" id="early-list"></div>
  </div>
</div>

</div>

<!-- Timeline Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div id="modal-title">Timeline</div>
        <div id="modal-sub" style="font-size:.65rem;color:var(--muted)"></div>
      </div>
      <button class="modal-close" onclick="closeTimeline()">Close</button>
    </div>
    <div class="modal-body" id="modal-content">Loading‚Ä¶</div>
  </div>
</div>

<script>
function minutesObserved(item){
  const base = item.first_passed_at || item.created_at;
  if(!base) return 0;
  return Math.floor((Date.now()-new Date(base))/60000);
}
function tierOf(item){
  if(item.core_confirmed) return "CORE";
  if(item.stable_confirmed) return "STABLE";
  if(item.forming_confirmed) return "FORMING";
  return "EARLY";
}
function renderCard(item){
  const mins = minutesObserved(item);
  const pct = Math.min(100, Math.round(mins/120*100));
  const tier = tierOf(item);

  return `
  <div class="card">
    <div class="card-top">
      <div>
        <div class="symbol">$${item.symbol||"???"}</div>
        <span class="badge ${tier}">${tier}</span>
      </div>
      <div class="score">${Number(item.banana_score||0).toFixed(2)}</div>
    </div>

    <div class="progress-wrap" title="Observed ${mins} mins">
      <div class="progress-label">
        <span>${mins} mins observed</span>
        <span>${pct}%</span>
      </div>
      <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
    </div>

    <div class="narrative">"${item.narrative_log||"‚Äî"}"</div>

    <div class="actions">
      <button class="btn" onclick="openTimeline('${item.ca}','${item.symbol}')">View Timeline</button>
      <div class="liq">üíß $${Math.round(item.liq||0).toLocaleString()}</div>
    </div>
  </div>`;
}

async function loadFeed(){
  const r = await fetch("/api/feed?limit=60",{cache:"no-store"});
  const js = await r.json();
  if(!js.ok){
    document.getElementById("early-list").innerHTML="<div class='empty'>Feed error</div>";
    return;
  }
  const core=js.zones.core||[], stable=js.zones.stable||[], early=js.zones.early||[];
  document.getElementById("core-list").innerHTML = core.length?core.map(renderCard).join(""):"<div class='empty'>No CORE yet</div>";
  document.getElementById("stable-list").innerHTML = stable.length?stable.map(renderCard).join(""):"<div class='empty'>No STABLE yet</div>";
  document.getElementById("early-list").innerHTML = early.length?early.map(renderCard).join(""):"<div class='empty'>No EARLY signals</div>";
}

async function openTimeline(ca,symbol){
  document.getElementById("modal-title").innerText=`Timeline ¬∑ $${symbol||""}`;
  document.getElementById("modal-sub").innerText=ca;
  document.getElementById("modal-content").innerText="Loading‚Ä¶";
  document.getElementById("modal-backdrop").style.display="flex";
  const r=await fetch(`/api/timeline?ca=${encodeURIComponent(ca)}&limit=100`);
  const js=await r.json();
  if(!js.ok||!js.timeline.length){
    document.getElementById("modal-content").innerText="No timeline yet.";
    return;
  }
  document.getElementById("modal-content").innerHTML=js.timeline.map(e=>`
    <div class="tl-item">
      <div class="tl-top">
        <div class="tl-evt">${e.event}</div>
        <div class="tl-time">${new Date(e.created_at).toLocaleString()}</div>
      </div>
      <div class="tl-detail">${JSON.stringify(e.payload||{})}</div>
    </div>`).join("");
}
function closeTimeline(){
  document.getElementById("modal-backdrop").style.display="none";
}

loadFeed();
setInterval(loadFeed,10000);
</script>
</body>
</html>
